<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MakeYourTrip - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        [x-cloak] { display: none !important; }
        .step-active { @apply gradient-bg text-white shadow-lg; }
        .step-inactive { @apply bg-gray-300 text-gray-600; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="flex items-center space-x-2 hover:opacity-80 transition-opacity">
                    <i class="fas fa-arrow-left"></i>
                    <span class="text-sm">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </a>
                <h1 class="text-2xl font-bold">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</h1>
            </div>
            <button id="authButton" class="bg-white/20 backdrop-blur-sm border border-white/30 text-white px-6 py-2 rounded-full hover:bg-white/30 transition-all">
                –í–æ–π—Ç–∏
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-8">
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="max-w-4xl mx-auto mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏</h2>
            <p class="text-gray-600 mb-6">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</p>
            
            <!-- –®–∞–≥–∏ -->
            <div class="flex justify-between relative mb-8">
                <div class="step-indicator flex flex-col items-center z-10">
                    <div id="step1" class="step-active w-10 h-10 rounded-full flex items-center justify-center font-bold mb-2">1</div>
                    <span class="text-sm font-medium">–ì–æ—Ä–æ–¥</span>
                </div>
                <div class="step-indicator flex flex-col items-center z-10">
                    <div id="step2" class="step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold mb-2">2</div>
                    <span class="text-sm text-gray-500">–§–∏–ª—å—Ç—Ä—ã</span>
                </div>
                <div class="step-indicator flex flex-col items-center z-10">
                    <div id="step3" class="step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold mb-2">3</div>
                    <span class="text-sm text-gray-500">–ú–µ—Å—Ç–∞</span>
                </div>
                <div class="absolute top-5 left-0 w-full h-0.5 bg-gray-200 -z-10"></div>
                <div id="progressBar" class="absolute top-5 left-0 h-0.5 gradient-bg -z-10" style="width: 33%"></div>
            </div>
        </div>

        <!-- –®–∞–≥ 1: –ì–æ—Ä–æ–¥–∞ -->
        <div id="step1Section" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</h3>
                <p class="text-gray-600 mb-6">–í—Å–µ –≥–æ—Ä–æ–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
                
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="mb-8">
                    <div class="flex space-x-3">
                        <input type="text" id="citySearch" placeholder="–ù–∞–π—Ç–∏ –≥–æ—Ä–æ–¥..." 
                               class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button onclick="searchCity()" class="gradient-bg text-white px-6 py-3 rounded-xl font-medium hover:opacity-90">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <p id="searchResult" class="text-sm mt-2"></p>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ -->
                <div id="citiesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                    <div class="col-span-2 flex justify-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä—ã -->
        <div id="step2Section" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
                <p class="text-gray-600 mb-6">–í—ã–±—Ä–∞–Ω: <span id="selectedCity" class="font-bold text-purple-600"></span></p>
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="mb-8">
                    <h4 class="font-bold text-gray-800 mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–µ—Å—Ç:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="restaurant" class="mr-3 text-purple-600">
                            <span><i class="fas fa-utensils mr-2"></i>–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="museum" class="mr-3 text-purple-600">
                            <span><i class="fas fa-landmark mr-2"></i>–ú—É–∑–µ–∏</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="landmark" class="mr-3 text-purple-600">
                            <span><i class="fas fa-monument mr-2"></i>–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="park" class="mr-3 text-purple-600">
                            <span><i class="fas fa-tree mr-2"></i>–ü–∞—Ä–∫–∏</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="shopping" class="mr-3 text-purple-600">
                            <span><i class="fas fa-shopping-bag mr-2"></i>–®–æ–ø–ø–∏–Ω–≥</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" value="cafe" class="mr-3 text-purple-600">
                            <span><i class="fas fa-coffee mr-2"></i>–ö–∞—Ñ–µ</span>
                        </label>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ -->
                <button onclick="applyFilters()" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg hover:opacity-90">
                    –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–∞
                </button>
            </div>
        </div>

        <!-- –®–∞–≥ 3: –ú–µ—Å—Ç–∞ -->
        <div id="step3Section" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞</h3>
                    <p class="text-gray-600" id="placesCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –º–µ—Å—Ç -->
                <div id="placesContainer" class="space-y-4">
                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                    <div class="flex justify-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                    </div>
                </div>

                <!-- –ò—Ç–æ–≥ -->
                <div class="mt-8 pt-6 border-t">
                    <div class="bg-blue-50 rounded-xl p-4 mb-6">
                        <p class="text-blue-800"><i class="fas fa-info-circle mr-2"></i>
                            –í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç: <span id="selectedCount" class="font-bold">0</span>
                        </p>
                    </div>
                    <button onclick="generatePlan()" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg hover:opacity-90">
                        –°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p>¬© 2024 MakeYourTrip. –†–µ–∂–∏–º "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä"</p>
        </div>
    </footer>

    <script>
        // ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        const API_URL = 'http://127.0.0.1:8000/api';
        let currentCity = null;
        let selectedPlaces = [];
        
        // –¢–∏–ø—ã –º–µ—Å—Ç
        const placeTypes = {
            restaurant: { icon: 'fa-utensils', color: 'text-red-500', bg: 'bg-red-100' },
            museum: { icon: 'fa-landmark', color: 'text-blue-500', bg: 'bg-blue-100' },
            landmark: { icon: 'fa-monument', color: 'text-green-500', bg: 'bg-green-100' },
            park: { icon: 'fa-tree', color: 'text-emerald-500', bg: 'bg-emerald-100' },
            shopping: { icon: 'fa-shopping-bag', color: 'text-purple-500', bg: 'bg-purple-100' },
            cafe: { icon: 'fa-coffee', color: 'text-amber-500', bg: 'bg-amber-100' }
        };

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–û–†–û–î–û–í ==========
        async function loadCities() {
            const container = document.getElementById('citiesContainer');
            
            try {
                const response = await fetch(`${API_URL}/cities`);
                const cities = await response.json();
                
                if (cities.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –≤ –±–∞–∑–µ</p>';
                    return;
                }
                
                container.innerHTML = cities.map(city => `
                    <div class="card-hover bg-white border rounded-xl p-5 hover:border-purple-300">
                        <div class="flex items-start mb-3">
                            <div class="w-12 h-12 gradient-bg rounded-lg flex items-center justify-center text-white mr-4">
                                <i class="fas fa-city"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">${city.name}</h4>
                                <p class="text-gray-500 text-sm">${city.climate}</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${city.description || ''}</p>
                        <button onclick="selectCity(${city.id}, '${city.name}')" 
                                class="w-full gradient-bg text-white py-2 rounded-lg font-medium hover:opacity-90">
                            –í—ã–±—Ä–∞—Ç—å
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8">
                        <p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>
                        <button onclick="loadCities()" class="mt-3 text-purple-600">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }

        async function searchCity() {
            const input = document.getElementById('citySearch');
            const result = document.getElementById('searchResult');
            const query = input.value.trim();
            
            if (!query) {
                result.innerHTML = '<span class="text-red-500">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span>';
                return;
            }
            
            try {
                result.innerHTML = '<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-2"></i>–ü–æ–∏—Å–∫...</span>';
                const response = await fetch(`${API_URL}/cities?search=${encodeURIComponent(query)}`);
                const cities = await response.json();
                
                if (cities.length === 0) {
                    result.innerHTML = `<span class="text-gray-600">"${query}" –Ω–µ –Ω–∞–π–¥–µ–Ω</span>`;
                } else if (cities.length === 1) {
                    const city = cities[0];
                    result.innerHTML = `
                        <span class="text-green-600">–ù–∞–π–¥–µ–Ω: ${city.name}</span>
                        <button onclick="selectCity(${city.id}, '${city.name}')" 
                                class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded">
                            –í—ã–±—Ä–∞—Ç—å
                        </button>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="text-green-600">–ù–∞–π–¥–µ–Ω–æ ${cities.length} –≥–æ—Ä–æ–¥–æ–≤:</span>
                        <div class="mt-2 space-y-1">
                            ${cities.map(city => `
                                <div class="flex justify-between">
                                    <span>${city.name}</span>
                                    <button onclick="selectCity(${city.id}, '${city.name}')" 
                                            class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        –í—ã–±—Ä–∞—Ç—å
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<span class="text-red-500">–û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }

        function selectCity(id, name) {
            currentCity = { id, name };
            document.getElementById('selectedCity').textContent = name;
            
            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2
            document.getElementById('step1Section').classList.add('hidden');
            document.getElementById('step2Section').classList.remove('hidden');
            updateProgress(2);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–ï–°–¢ ==========
        async function applyFilters() {
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã
            const checkboxes = document.querySelectorAll('#step2Section input[type="checkbox"]:checked');
            const types = Array.from(checkboxes).map(cb => cb.value);
            
            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 3
            document.getElementById('step2Section').classList.add('hidden');
            document.getElementById('step3Section').classList.remove('hidden');
            updateProgress(3);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Å—Ç–∞
            await loadPlaces(types);
        }

        async function loadPlaces(types = []) {
            const container = document.getElementById('placesContainer');
            const countElement = document.getElementById('placesCount');
            
            container.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                </div>
            `;
            
            try {
                let url = `${API_URL}/cities/${currentCity.id}/places`;
                const response = await fetch(url);
                let places = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã
                if (types.length > 0) {
                    places = places.filter(p => types.includes(p.type));
                }
                
                countElement.textContent = `–ù–∞–π–¥–µ–Ω–æ ${places.length} –º–µ—Å—Ç`;
                
                if (places.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">–ù–µ—Ç –º–µ—Å—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                            <button onclick="goBackToFilters()" class="mt-3 text-purple-600">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                        </div>
                    `;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞
                const token = localStorage.getItem('access_token');
                const favoritesPromises = places.map(async (place) => {
                    if (!token) return { place, isFavorite: false };
                    
                    try {
                        const favResponse = await fetch(`${API_URL}/favorites/${place.id}/check`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (favResponse.ok) {
                            const favData = await favResponse.json();
                            return { place, isFavorite: favData.is_favorite };
                        }
                    } catch (e) {
                        console.error('Error checking favorite:', e);
                    }
                    return { place, isFavorite: false };
                });
                
                const placesWithFavorites = await Promise.all(favoritesPromises);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Å—Ç–∞
                container.innerHTML = placesWithFavorites.map(({ place, isFavorite }) => {
                    const type = placeTypes[place.type] || { icon: 'fa-map-marker', color: 'text-gray-500', bg: 'bg-gray-100' };
                    const stars = '‚òÖ'.repeat(Math.floor(place.rating)) + '‚òÜ'.repeat(5 - Math.floor(place.rating));
                    
                    return `
                        <div class="flex items-center justify-between p-4 border rounded-xl hover:bg-gray-50">
                            <div class="flex items-center">
                                <div class="w-12 h-12 ${type.bg} rounded-lg flex items-center justify-center ${type.color} mr-4">
                                    <i class="fas ${type.icon}"></i>
                                </div>
                                <div>
                                    <h5 class="font-bold text-gray-800">${place.name}</h5>
                                    <p class="text-gray-500 text-sm">${place.type}</p>
                                    <div class="text-yellow-500 text-sm">${stars} ${place.rating.toFixed(1)}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="toggleFavorite(${place.id}, '${place.name}')" 
                                    class="flex items-center space-x-1 bg-red-100 text-red-600 hover:bg-red-200 px-3 py-2 rounded-lg">
                                    <i class="far fa-heart"></i>
                                        <span>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                                </button>
                                <button onclick="toggleFavorite(${place.id}, '${place.name}')" 
                                        class="flex items-center space-x-1 ${isFavorite ? 'bg-red-500 text-white' : 'bg-red-100 text-red-600 hover:bg-red-200'} px-3 py-2 rounded-lg">
                                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>
                    </div>
                `;
            }
        }

        function addToPlan(id, name) {
            if (!selectedPlaces.find(p => p.id === id)) {
                selectedPlaces.push({ id, name });
                document.getElementById('selectedCount').textContent = selectedPlaces.length;
                showNotification(`"${name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–ª–∞–Ω`);
            } else {
                showNotification('–£–∂–µ –≤ –ø–ª–∞–Ω–µ', 'info');
            }
        }

        function goBackToFilters() {
            document.getElementById('step3Section').classList.add('hidden');
            document.getElementById('step2Section').classList.remove('hidden');
            updateProgress(2);
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function updateProgress(step) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —à–∞–≥–æ–≤
            document.querySelectorAll('.step-indicator div').forEach((div, index) => {
                div.className = index < step ? 'step-active w-10 h-10 rounded-full flex items-center justify-center font-bold mb-2' 
                                           : 'step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold mb-2';
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            document.querySelectorAll('.step-indicator span').forEach((span, index) => {
                span.className = index < step ? 'text-sm font-medium' : 'text-sm text-gray-500';
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            document.getElementById('progressBar').style.width = `${step * 33}%`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'} mr-2"></i>${message}`;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function generatePlan() {
            if (selectedPlaces.length === 0) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ', 'info');
                return;
            }
            
            const plan = `
                üó∫Ô∏è –ü–ª–∞–Ω –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ ${currentCity.name}
                
                üìç –í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç: ${selectedPlaces.length}
                
                üéØ –ú–∞—Ä—à—Ä—É—Ç:
                ${selectedPlaces.map((p, i) => `${i+1}. ${p.name}`).join('\n')}
                
                üí° –°–æ–≤–µ—Ç: –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–µ—Å—Ç–∞ –ª–æ–≥–∏—á–Ω–æ –ø–æ –¥–Ω—è–º!
            `;
            
            alert(plan);
        }

        // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            const button = document.getElementById('authButton');
            
            if (!token) {
                button.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>–í–æ–π—Ç–∏';
                // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ auth.html
                button.onclick = () => window.location.href = 'auth.html';
                return false;
            }
            
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    headers: { 
                        'Authorization': `Bearer ${token}` 
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const user = await response.json();
                button.innerHTML = `<i class="fas fa-user mr-2"></i>${user.username}`;
                button.onclick = () => window.location.href = 'profile.html';
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                localStorage.removeItem('access_token');
                button.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>–í–æ–π—Ç–∏';
                button.onclick = () => window.location.href = 'auth.html';
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            checkAuth();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            checkAuth();
            updateProgress(1);
        });

        async function toggleFavorite(placeId, placeName) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                return;
            }
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
                const checkResponse = await fetch(`${API_URL}/favorites/${placeId}/check`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let isFavorite = false;
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    isFavorite = checkData.is_favorite;
                }
                
                if (!isFavorite) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    const response = await fetch(`${API_URL}/favorites`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ place_id: placeId })
                    });
                    
                    if (response.ok) {
                        showNotification(`"${placeName}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ! ‚ù§Ô∏è`, 'success');
                        return true;
                    }
                } else {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    const response = await fetch(`${API_URL}/favorites/${placeId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        showNotification(`"${placeName}" —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`, 'info');
                        return false;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º', 'error');
            }
            return null;
        }


    </script>
</body>
</html>